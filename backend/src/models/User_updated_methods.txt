userSchema.methods.addFcmToken = async function(token) {
  if (!token) return this;

  if (!this.fcmTokens.includes(token)) {
    this.fcmTokens.push(token);
    await this.save();
  }

  return this;
};

// Instance method to add venue to favorites
userSchema.methods.addFavorite = async function(venueId) {
  if (!this.favoriteVenues.includes(venueId)) {
    this.favoriteVenues.push(venueId);
    await this.save();
  }
  return this;
};

// Instance method to remove venue from favorites
userSchema.methods.removeFavorite = async function(venueId) {
  this.favoriteVenues = this.favoriteVenues.filter(
    id => id.toString() !== venueId.toString()
  );
  await this.save();
  return this;
};

// Instance method to get favorite venues
userSchema.methods.getFavorites = async function() {
  const Venue = mongoose.model('Venue');
  return await Venue.find({ 
    _id: { $in: this.favoriteVenues },
    isActive: true 
  });
};

// Static method to find user by email (including password for login)
userSchema.statics.findByEmailWithPassword = function(email) {
  return this.findOne({ email }).select('+password');
};

// Static method to find user by email (without password)
userSchema.statics.findByEmail = function(email) {
  return this.findOne({ email });
};

// Create and export the model
const User = mongoose.model('User', userSchema);

module.exports = User;
